// Copyright Voxel Plugin, Inc. All Rights Reserved.

#include "VoxelGraphInstance.h"
#include "VoxelGraphExecutor.h"
#include "VoxelParameterContainer.h"

DEFINE_VOXEL_FACTORY(UVoxelGraphInstance);

UVoxelGraphInstance::UVoxelGraphInstance()
{
	ParameterContainer = CreateDefaultSubobject<UVoxelParameterContainer>("ParameterContainer");
	ParameterContainer->OnProviderChanged.AddWeakLambda(this, [this]
	{
		GVoxelGraphExecutorManager->NotifyGraphChanged(*this);
	});
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

void UVoxelGraphInstance::SetParentGraph(UVoxelGraphInterface* NewParentGraph)
{
	ParameterContainer->SetProvider(NewParentGraph);
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

void UVoxelGraphInstance::PostLoad()
{
	Super::PostLoad();

	if (Parent_DEPRECATED)
	{
		ensure(!ParameterContainer->Provider);
		ParameterContainer->Provider = Parent_DEPRECATED.Get();
		Parent_DEPRECATED = {};

		ParameterCollection_DEPRECATED.MigrateTo(*ParameterContainer);
	}
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

UVoxelGraph* UVoxelGraphInstance::GetGraph() const
{
	ParameterContainer->FixupProvider();

	const UVoxelGraphInterface* Interface = Cast<UVoxelGraphInterface>(ParameterContainer->Provider);
	if (!Interface)
	{
		ensure(!ParameterContainer->Provider);
		return nullptr;
	}
	return Interface->GetGraph();
}

///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////

IVoxelParameterProvider* UVoxelGraphInstance::GetSourceProvider()
{
	return ParameterContainer;
}